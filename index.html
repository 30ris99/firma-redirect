<!DOCTYPE html>
<html lang="it">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Documenti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --primary-hover: #34495e;
            --secondary-color: #95a5a6;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --background-color: #ecf0f1;
            --container-bg-color: #ffffff;
            --text-color-dark: #34495e;
            --text-color-light: #7f8c8d;
            --border-color: #bdc3c7;
            --font-headings: 'Montserrat', sans-serif;
            --font-body: 'Roboto', sans-serif;
        }
        body {
            font-family: var(--font-body);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px 15px;
            background-color: var(--background-color);
            margin: 0;
            min-height: 100vh;
            box-sizing: border-box;
        }
        #page-header {
            width: 100%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #page-header h1 {
            font-family: var(--font-headings);
            font-weight: 600;
            font-size: 1.4em;
            margin: 0 0 5px 0;
            color: var(--text-color-dark);
        }
        #page-header p {
            margin: 3px 0;
            font-size: 0.95em;
            color: var(--text-color-light);
            line-height: 1.4;
        }
        #container {
            background: var(--container-bg-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 500px;
        }
        #container h3 {
            font-family: var(--font-headings);
            font-weight: 500;
            font-size: 1.2em;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--text-color-dark);
        }
        #doc-list-container h4 {
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em;
            color: var(--text-color-dark);
        }
        #doc-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
            padding: 10px;
        }
        #doc-list li {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        #doc-list li:last-child {
            border-bottom: none;
        }
        #doc-list a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
            transition: color 0.2s;
        }
        #doc-list a:hover {
            color: #000;
        }
        #doc-list li::before {
            content: 'ðŸ“„';
            margin-right: 10px;
            font-size: 1.1em;
        }
        .no-docs {
            color: var(--text-color-light);
            font-style: italic;
        }
        #signature-pad-container {
            width: 100%;
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            margin: 25px 0;
            touch-action: none;
            position: relative;
        }
        #signature-pad {
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        #consent-container {
            margin-bottom: 25px;
        }
        #consent-container label {
            font-size: 0.8em;
            line-height: 1.5;
            color: var(--text-color-light);
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }
        #consent-container input[type="checkbox"] {
            margin-right: 12px;
            margin-top: 3px;
            width: 1.1em;
            height: 1.1em;
            accent-color: var(--primary-color);
        }
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        button {
            padding: 14px;
            font-size: 1em;
            font-family: var(--font-headings);
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            transition: all 0.2s ease;
        }
        button:disabled {
            background-color: var(--secondary-color) !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #clear-button {
            background-color: #7f8c8d;
            color: white;
        }
        #clear-button:hover:not(:disabled) {
            background-color: #6c7b7d;
        }
        #save-button {
            background-color: var(--primary-color);
            color: white;
        }
        #save-button:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        #message {
            margin-top: 25px;
            font-weight: 500;
            text-align: center;
            min-height: 2.5em;
            white-space: pre-wrap;
            transition: all 0.3s;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <header id="page-header">
        <h1>Ing. Dino Boris Tulone</h1>
        <p>Studio di Progettazione ed Urbanistica</p>
        <p>Via Cappuccini n.55 - 92019 Sciacca (AG)</p>
    </header>
    <div id="container">
        <p style="text-align:center;">Caricamento dei documenti in corso...</p>
    </div>
    <script>
        const WEB_APP_API_URL = "https://script.google.com/macros/s/AKfycbzOLdeYuQZaeyiE98trQ08xJknhapPInXPqBi7T2YB3APCYeWkngjvcXPV4MPlIB1Gs/exec";
        const container = document.getElementById('container');
        const params = new URLSearchParams(window.location.search);
        const folderId = params.get('folderId');

        let filesToProcess = [];
        let processedFiles = [];
        let signaturePadInstance;

        window.addEventListener('load', () => {
            if (!folderId) {
                renderError('Link non valido: ID della cartella non specificato.');
                return;
            }
            fetch(`${WEB_APP_API_URL}?folderId=${folderId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        filesToProcess = data.documents;
                        renderSigningInterface(filesToProcess);
                    } else {
                        renderError(data.message);
                    }
                })
                .catch(() => renderError('Impossibile comunicare con il server di firma.'));
        });

        function renderError(msg) {
            container.innerHTML = `<h3 style="color: var(--danger-color);">Errore</h3><p>${msg}</p>`;
        }

        function renderSigningInterface(docs) {
            let html = docs.length
                ? docs.map(d => `<li><a href="${d.url}" target="_blank">${d.name}</a></li>`).join('')
                : '<li class="no-docs">Nessun documento trovato.</li>';
            container.innerHTML = `
                <h3>Revisione e Firma Documenti</h3>
                <div id="doc-list-container">
                    <h4>Documenti:</h4>
                    <ul id="doc-list">${html}</ul>
                </div>
                <p style="text-align:center; color:#666;">Disegna la tua firma:</p>
                <div id="signature-pad-container"><canvas id="signature-pad"></canvas></div>
                <div id="consent-container">
                    <label><input type="checkbox" id="consent-checkbox">
                    <span>Â«Dichiaro di aver preso completa visione dei documenti sopra elencati, di approvarne integralmente il contenuto e di esprimere il mio pieno consenso. Comprendo che la sottoscrizione elettronica apposta con il presente strumento ha valore legale equivalente alla firma autografa. Accetto che il sistema registri e conservi prova informatica dellâ€™operazione di firma, incluso riconoscimento della mia identitÃ  e data/ora dellâ€™apposizione.Â»</span>
                    </label>
                </div>
                <div class="buttons">
                    <button id="clear-button">Pulisci</button>
                    <button id="save-button">Accetta e Firma</button>
                </div>
                <div id="message"></div>
            `;
            if (docs.length > 0) {
                initializeSigningPad();
            }
        }

        function initializeSigningPad() {
            const canvas = document.getElementById('signature-pad');
            const saveBtn = document.getElementById('save-button');
            const clearBtn = document.getElementById('clear-button');
            const consent = document.getElementById('consent-checkbox');
            const padContainer = document.getElementById('signature-pad-container');

            signaturePadInstance = new SignaturePad(canvas, { penColor: 'black', minWidth:0.5, maxWidth:1.5 });

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio||1,1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
                signaturePadInstance.clear();
            }

            padContainer.style.height = padContainer.offsetWidth * 0.3 + 'px';
            window.addEventListener('resize', () => {
                padContainer.style.height = padContainer.offsetWidth * 0.3 + 'px';
                resizeCanvas();
            });
            resizeCanvas();

            consent.addEventListener('change', () => saveBtn.disabled = !consent.checked);
            clearBtn.addEventListener('click', () => signaturePadInstance.clear());
            saveBtn.disabled = true;

            saveBtn.addEventListener('click', () => {
                if (signaturePadInstance.isEmpty()) {
                    alert('Ãˆ necessario apporre la firma prima di procedere.');
                    return;
                }
                setLoading(true, 'Avvio processo di firma...');
                const sigData = signaturePadInstance.toDataURL();
                processedFiles = []; // Resetta l'array prima di iniziare
                processNext(0, sigData);
            });
        }

        function processNext(i, sigData) {
            const msg = document.getElementById('message');
            if (i >= filesToProcess.length) {
                finalize(sigData);
                return;
            }
            const file = filesToProcess[i];
            msg.textContent = `Firmando ${i+1}/${filesToProcess.length}: ${file.name}`;
            
            const fd = new URLSearchParams();
            fd.append('action','processFile');
            fd.append('signatureData', sigData);
            fd.append('fileId', file.id);
            fd.append('folderId', folderId);

            fetch(WEB_APP_API_URL, { method:'POST', body:fd })
                .then(r => r.json())
                .then(result => {
                    // **FIX**: Popola l'array dei file processati
                    if (result.success && result.data.status === 'success') {
                        processedFiles.push(result.data.fileName);
                    } else if (result.success && result.data.status === 'skipped') {
                        console.log(`File saltato: ${result.data.fileName} - Motivo: ${result.data.reason}`);
                    }
                    // Continua con il file successivo
                    processNext(i + 1, sigData);
                })
                .catch(e => showError(e));
        }

        function finalize(sigData) {
            const msg = document.getElementById('message');
            msg.textContent = 'Finalizzazione e salvataggio della prova in corso...';
            html2canvas(document.body, { useCORS:true, scale:1 }).then(canvas => {
                const img = canvas.toDataURL('image/jpeg',0.7);
                const fd = new URLSearchParams();
                fd.append('action','saveProof');
                fd.append('screenshotData', img);
                fd.append('folderId', folderId);
                // **FIX**: Invia i nomi dei file effettivamente firmati
                fd.append('signedFileNames', processedFiles.join(','));

                fetch(WEB_APP_API_URL, { method:'POST', body:fd })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess(`Processo completato con successo! I documenti firmati sono nella cartella: "${data.data.destinationFolderName}"`);
                            setLoading(false); // Riabilita i pulsanti
                            document.getElementById('save-button').style.display = 'none'; // Nasconde il pulsante firma
                            document.getElementById('clear-button').style.display = 'none'; // Nasconde il pulsante pulisci
                        } else {
                            showError(data.message);
                        }
                    }).catch(e => showError(e));
            });
        }

        function setLoading(isLoading, text='') {
            document.getElementById('message').textContent = text;
            const buttons = document.querySelectorAll('.buttons button');
            buttons.forEach(b => b.disabled = isLoading);
            document.getElementById('consent-checkbox').disabled = isLoading;
            
            if (signaturePadInstance) {
                if (isLoading) {
                    signaturePadInstance.off();
                } else {
                    signaturePadInstance.on();
                }
            }
        }

        function showSuccess(txt) {
            const msg = document.getElementById('message');
            msg.textContent = txt;
            msg.style.color = 'var(--success-color)';
        }

        function showError(err) {
            const msg = document.getElementById('message');
            msg.textContent = 'Errore: ' + (err.message || err);
            msg.style.color = 'var(--danger-color)';
            setLoading(false); // Sblocca l'interfaccia in caso di errore
        }
    </script>
</body>
</html>

